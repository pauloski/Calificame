<!--Ajuste 2.0-->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Evaluaci√≥n Docente</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- P√°gina de Login -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-header">
                <h2>Plataforma de Evaluaci√≥n Docente</h2>
                <p>Accede o registra tu cuenta</p>
            </div>

            <div class="login-tabs">
                <button class="login-tab active" data-tab="login">Iniciar Sesi√≥n</button>
                <button class="login-tab" data-tab="register">Registrarse</button>
            </div>

            <!-- Formulario de Login -->
            <form id="loginForm" class="tab-content active">
                <div class="form-group">
                    <label>Correo Electr√≥nico</label>
                    <input type="email" class="form-control" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    Iniciar Sesi√≥n
                </button>
            </form>

            <!-- Formulario de Registro -->
            <form id="registerForm" class="tab-content" style="display: none;">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" class="form-control" id="registerName" required>
                </div>
                <div class="form-group">
                    <label>Correo Electr√≥nico</label>
                    <input type="email" class="form-control" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>Universidad</label>
                    <input type="text" class="form-control" id="registerUniversity" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" class="form-control" id="registerPassword" required>
                </div>
                <div class="form-group">
                    <label>Confirmar Contrase√±a</label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    Registrarse
                </button>
            </form>
        </div>
    </div>

    <!-- Aplicaci√≥n Principal -->
    <div id="mainApp" class="page">
        <div class="header">
            <div class="header-content">
                <div class="logo">Eval√∫aDocente</div>
                <nav class="nav-menu">
                    <button class="nav-btn active" data-page="nuevo-reporte">Nuevo Reporte</button>
                    <button class="nav-btn" data-page="reportes-guardados">Reportes Guardados</button>
                    <button class="nav-btn" data-page="carga-masiva">Carga Masiva</button>
                    <button class="nav-btn" id="logoutBtn">Cerrar Sesi√≥n</button>
                </nav>
            </div>
        </div>

        <div class="container">
            <!-- P√°gina: Nuevo Reporte -->
            <div id="nuevo-reporte" class="page active">
                <div class="main-content">
                    <h2 style="margin-bottom: 2rem; color: #2d3748;">Crear Nuevo Reporte de Evaluaci√≥n</h2>

                    <form id="reportForm">
                        <!-- Secci√≥n 1: Informaci√≥n General -->
                        <div class="form-section">
                            <h3>üìã Informaci√≥n General</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nombre del Estudiante *</label>
                                    <input type="text" class="form-control" id="nombreEstudiante" required>
                                </div>
                                <div class="form-group">
                                    <label>Fecha *</label>
                                    <input type="date" class="form-control" id="fecha" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nombre del Docente *</label>
                                    <input type="text" class="form-control" id="nombreDocente" required>
                                </div>
                                <div class="form-group">
                                    <label>Asignatura *</label>
                                    <input type="text" class="form-control" id="asignatura" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Carrera *</label>
                                    <input type="text" class="form-control" id="carrera" required>
                                </div>
                                <div class="form-group">
                                    <label>Universidad *</label>
                                    <input type="text" class="form-control" id="universidad" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>T√≠tulo de la Evaluaci√≥n / Taller *</label>
                                    <input type="text" class="form-control" id="tituloEvaluacion" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Descripci√≥n de la Evaluaci√≥n</label>
                                <textarea class="form-control" id="descripcionEvaluacion" rows="3"
                                    placeholder="Describa brevemente la evaluaci√≥n o taller..."></textarea>
                            </div>
                        </div>

                        <!-- Secci√≥n 2: Configuraci√≥n del Instrumento -->
                        <div class="form-section">
                            <h3>‚öôÔ∏è Configuraci√≥n del Instrumento de Evaluaci√≥n</h3>

                            <!-- Escala de Calificaci√≥n -->
                            <h4 style="margin-bottom: 1rem; color: #4a5568;">Escala de Calificaci√≥n</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nota M√≠nima *</label>
                                    <input type="number" step="0.1" class="form-control" id="notaMinima" value="1.0"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label>Nota M√°xima *</label>
                                    <input type="number" step="0.1" class="form-control" id="notaMaxima" value="7.0"
                                        required>
                                </div>
                                <div class="form-group">
                                    <label>Nota de Aprobaci√≥n *</label>
                                    <input type="number" step="0.1" class="form-control" id="notaAprobacion" value="4.0"
                                        required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Exigencia (%) *</label>
                                    <input type="number" min="1" max="100" class="form-control" id="exigencia"
                                        value="60" required>
                                </div>
                                <div class="form-group">
                                    <label>Incremento (opcional)</label>
                                    <input type="number" step="0.1" class="form-control" id="incremento" value="0.1">
                                </div>
                            </div>

                            <!-- Niveles de Desempe√±o -->
                            <h4 style="margin: 2rem 0 1rem 0; color: #4a5568;">Niveles de Desempe√±o</h4>
                            <div id="nivelesDesempeno">
                                <!-- Los niveles se generan din√°micamente -->
                            </div>
                            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                <button type="button" class="btn btn-secondary" id="agregarNivel">+ Agregar
                                    Nivel</button>
                                <button type="button" class="btn btn-secondary" id="restablecerNiveles">Restablecer
                                    Predeterminados</button>
                            </div>

                            <!-- Criterios de Evaluaci√≥n -->
                            <h4 style="margin: 2rem 0 1rem 0; color: #4a5568;">Criterios de Evaluaci√≥n</h4>
                            <button type="button" class="btn btn-primary" id="agregarCriterio">+ Agregar
                                Criterio</button>

                            <div class="table-container" style="margin-top: 1rem;">
                                <table class="criteria-table" id="criteriosTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Criterio</th>
                                            <th style="width: 18%;">Excelente</th>
                                            <th style="width: 18%;">Bueno</th>
                                            <th style="width: 18%;">Regular</th>
                                            <th style="width: 18%;">Insuficiente</th>
                                            <th style="width: 8%;">Evaluaci√≥n</th>
                                            <th style="width: 8%;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Los criterios se agregan din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Secci√≥n 3: Feedback Docente -->
                        <div class="form-section">
                            <h3>üí¨ Feedback Docente</h3>
                            <div class="form-group">
                                <label>Comentario del Docente</label>
                                <textarea class="form-control" id="feedbackDocente" rows="4"
                                    placeholder="Escriba sus comentarios y retroalimentaci√≥n para el estudiante..."></textarea>
                            </div>

                            <div class="form-group" style="margin-top: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="puntosAdicionalesCheck">
                                    Activar Puntos Adicionales
                                </label>
                            </div>

                            <div id="puntosAdicionalesSection" style="display: none; margin-top: 1rem;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Puntos a agregar a la nota final (m√°x. 2.3) *</label>
                                        <input type="number" step="0.1" min="0" max="2.3" class="form-control"
                                            id="puntosAgregar">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Justificaci√≥n (obligatoria) *</label>
                                    <textarea class="form-control" id="justificacionPuntos" rows="2"
                                        placeholder="Ej: Por excelente participaci√≥n en clase y aporte al equipo..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acci√≥n -->
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                            <button type="button" class="btn btn-primary" id="generarPreview">
                                üîç Generar Vista Previa
                            </button>
                            <button type="reset" class="btn btn-secondary">üîÑ Limpiar Formulario</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- P√°gina: Reportes Guardados -->
            <div id="reportes-guardados" class="page">
                <div class="main-content">
                    <h2 style="margin-bottom: 2rem; color: #2d3748;">Reportes Guardados</h2>

                    <!-- Filtros -->
                    <div class="filter-section">
                        <h3 style="margin-bottom: 1rem;">Filtrar Reportes</h3>
                        <div class="filter-row">
                            <div class="form-group">
                                <label>Seleccionar Lista:</label>
                                <select class="form-control" id="filtroLista">
                                    <option value="">Todas las Listas</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Buscar por estudiante o evaluaci√≥n:</label>
                                <input type="text" class="form-control" id="busquedaReporte"
                                    placeholder="Escriba el nombre del estudiante o t√≠tulo de evaluaci√≥n...">
                            </div>
                            <button type="button" class="btn btn-primary" id="aplicarFiltros">Aplicar Filtros</button>
                            <button type="button" class="btn btn-success" id="descargarListadoPDF">üìÑ Descargar Listado
                                PDF</button>
                        </div>
                    </div>

                    <!-- Lista de Reportes -->
                    <div id="listaReportes">
                        <!-- Los reportes se cargan din√°micamente -->
                        <div style="text-align: center; padding: 3rem; color: #718096;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">
                                <div class="loading"></div>
                            </div>
                            <h3>Cargando reportes...</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P√°gina: Carga Masiva -->
            <div id="carga-masiva" class="page">
                <div class="main-content">
                    <h2 style="margin-bottom: 2rem; color: #2d3748;">Carga Masiva de Reportes</h2>

                    <div class="form-section">
                        <h3>üì§ Subir Archivo CSV</h3>
                        <p style="color: #718096; margin-bottom: 1.5rem;">
                            Suba un archivo CSV con los datos de m√∫ltiples estudiantes para generar reportes
                            autom√°ticamente.
                        </p>

                        <div class="upload-area" id="uploadArea">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                            <p><strong>Haga clic aqu√≠ o arrastre su archivo CSV</strong></p>
                            <p style="color: #718096; font-size: 0.875rem;">Formatos soportados: .csv</p>
                            <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        </div>

                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="sobrescribirReportes">
                                Sobrescribir reportes existentes con el mismo T√≠tulo de Evaluaci√≥n y Nombre de
                                Estudiante
                            </label>
                            <small style="color: #718096; margin-top: 0.5rem; display: block;">
                                Si est√° marcado, los reportes existentes ser√°n actualizados. De lo contrario, se
                                a√±adir√°n como nuevos.
                            </small>
                        </div>

                        <div style="margin-top: 2rem;">
                            <button type="button" class="btn btn-secondary" id="descargarPlantilla">
                                üì• Descargar Plantilla CSV
                            </button>
                            <button type="button" class="btn btn-primary" id="procesarCSV" disabled>
                                üöÄ Procesar Archivo
                            </button>
                        </div>
                    </div>

                    <!-- Resultados de la Carga -->
                    <div id="resultadosCarga" style="display: none;" class="form-section">
                        <h3>üìä Resultados de la Carga</h3>
                        <div id="estadisticasCarga"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Agregar/Editar Criterio -->
    <div id="criterioModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="criterioModalTitle">Agregar Criterio</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="criterioForm">
                <div class="form-group">
                    <label>Nombre del Criterio *</label>
                    <input type="text" class="form-control" id="criterioNombre" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n Excelente (3 pts) *</label>
                    <textarea class="form-control" id="criterioExcelente" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n Bueno (2 pts) *</label>
                    <textarea class="form-control" id="criterioBueno" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n Regular (1 pts) *</label>
                    <textarea class="form-control" id="criterioRegular" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n Insuficiente (0 pts) *</label>
                    <textarea class="form-control" id="criterioInsuficiente" rows="3" required></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Criterio</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Vista Previa del Reporte -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Vista Previa del Reporte</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div id="reportPreviewContent" class="report-preview">
                <!-- El contenido se genera din√°micamente -->
            </div>
            <div
                style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                <button type="button" class="btn btn-secondary" id="editarReporte">‚úèÔ∏è Editar Reporte</button>
                <button type="button" class="btn btn-success" id="descargarPDF">üìÑ Descargar PDF</button>
                <button type="button" class="btn btn-primary" id="guardarReporte">üíæ Guardar Reporte</button>
            </div>
        </div>
    </div>

    <!-- Modal: Guardar Reporte -->
    <div id="guardarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Guardar Reporte en Lista</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div>
                <p style="margin-bottom: 1.5rem;">Seleccione una opci√≥n para guardar el reporte:</p>

                <div class="form-group">
                    <label>Seleccionar lista existente:</label>
                    <select class="form-control" id="listaExistente">
                        <option value="">-- Sin Lista --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>O crear una nueva lista:</label>
                    <input type="text" class="form-control" id="nuevaLista"
                        placeholder="Nombre de la nueva lista (opcional)">
                    <small style="color: #718096; margin-top: 0.5rem; display: block;">
                        Deje en blanco si no desea crear una nueva lista o seleccionar una existente.
                    </small>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmarGuardar">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Vista Previa de Reporte Guardado -->
    <div id="vistaReporteModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Vista Previa del Reporte</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div id="vistaReporteContent">
                <!-- El contenido se genera din√°micamente -->
            </div>
            <div
                style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                <button type="button" class="btn btn-secondary" id="usarComoPlantilla">üìã Usar como Plantilla</button>
                <button type="button" class="btn btn-success" id="descargarPDFReporte">üìÑ Descargar PDF</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog/Alert -->
    <div id="custom-dialog" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h3 id="dialog-title" style="margin-bottom: 1rem;"></h3>
            <p id="dialog-message" style="margin-bottom: 2rem;"></p>
            <div id="dialog-actions">
                <button class="btn btn-secondary" id="dialog-cancel-btn" style="margin-right: 1rem;">Cancelar</button>
                <button class="btn btn-primary" id="dialog-confirm-btn">Confirmar</button>
            </div>
        </div>
    </div>

<!-- Modal: Eliminar Lista -->
<div id="eliminarListaModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Eliminar Lista de Reportes</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div>
            <!-- La informaci√≥n de las listas se insertar√° aqu√≠ -->
            <div class="listas-info"></div>

            <div class="form-group">
                <label>Seleccionar lista para eliminar:</label>
                <select class="form-control" id="listaAEliminar">
                    <option value="">-- Seleccione una lista --</option>
                </select>
                <small style="color: #e53e3e; margin-top: 0.5rem; display: block;">
                    ‚ö†Ô∏è Esta acci√≥n eliminar√° la lista y todos sus reportes asociados. No se puede deshacer.
                </small>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmarEliminarLista">
                    Eliminar Lista
                </button>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>


    <script>
        // ==========================================
        // VARIABLES GLOBALES Y CONFIGURACI√ìN
        // ==========================================

        let currentUser = null;
        let currentReport = null;
        let nivelesDesempeno = [
            { nombre: 'Insuficiente', puntaje: 0 },
            { nombre: 'Regular', puntaje: 1 },
            { nombre: 'Bueno', puntaje: 2 },
            { nombre: 'Excelente', puntaje: 3 }
        ];






        // ==========================================
        // UTILITIES
        // ==========================================

        /**
         * Muestra notificaciones toast
         */
        function showToast(message, type = 'success') {
            // Eliminar toasts existentes para evitar superposici√≥n
            document.querySelectorAll('.toast').forEach(t => t.remove());

            // Crear elemento toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            // Agregar al DOM
            document.body.appendChild(toast);

            // Mostrar con animaci√≥n
            setTimeout(() => toast.classList.add('show'), 100);

            // Ocultar y eliminar despu√©s de 4 segundos
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        /**
         * Muestra un di√°logo de confirmaci√≥n personalizado.
         */
        function showCustomDialog(title, message) {
            return new Promise(resolve => {
                const dialog = document.getElementById('custom-dialog');
                document.getElementById('dialog-title').textContent = title;
                document.getElementById('dialog-message').textContent = message;
                document.getElementById('dialog-cancel-btn').style.display = 'inline-block';
                document.getElementById('dialog-confirm-btn').textContent = 'Confirmar';

                const onConfirm = () => {
                    dialog.classList.remove('active');
                    resolve(true);
                    cleanUp();
                };

                const onCancel = () => {
                    dialog.classList.remove('active');
                    resolve(false);
                    cleanUp();
                };

                const cleanUp = () => {
                    document.getElementById('dialog-confirm-btn').removeEventListener('click', onConfirm);
                    document.getElementById('dialog-cancel-btn').removeEventListener('click', onCancel);
                    dialog.removeEventListener('click', onOutsideClick);
                };

                const onOutsideClick = (e) => {
                    if (e.target === dialog) onCancel();
                };

                document.getElementById('dialog-confirm-btn').addEventListener('click', onConfirm);
                document.getElementById('dialog-cancel-btn').addEventListener('click', onCancel);
                dialog.addEventListener('click', onOutsideClick);

                dialog.classList.add('active');
            });
        }

        /**
         * Muestra un mensaje simple en un di√°logo.
         */
        function showMessageDialog(title, message) {
            return new Promise(resolve => {
                const dialog = document.getElementById('custom-dialog');
                document.getElementById('dialog-title').textContent = title;
                document.getElementById('dialog-message').textContent = message;
                document.getElementById('dialog-cancel-btn').style.display = 'none';
                document.getElementById('dialog-confirm-btn').textContent = 'Aceptar';

                const onConfirm = () => {
                    dialog.classList.remove('active');
                    cleanUp();
                    resolve();
                };

                const cleanUp = () => {
                    document.getElementById('dialog-confirm-btn').removeEventListener('click', onConfirm);
                    dialog.removeEventListener('click', onOutsideClick);
                };

                const onOutsideClick = (e) => {
                    if (e.target === dialog) onConfirm();
                };

                document.getElementById('dialog-confirm-btn').addEventListener('click', onConfirm);
                dialog.addEventListener('click', onOutsideClick);

                dialog.classList.add('active');
            });
        }

        /**
         * Cierra todos los modales abiertos
         */
        function cerrarModales() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        /**
         * Helper para llamadas a la API
         */
        async function fetchAPI(endpoint, options = {}) {
            const token = localStorage.getItem('userToken');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`/api${endpoint}`, {
                ...options,
                headers
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message);
            }

            return response.json();
        }

        // ==========================================
        // FUNCIONES DE AUTENTICACI√ìN
        // ==========================================

        /**
         * Inicializa el sistema de autenticaci√≥n y eventos principales
         */
        function initAuth() {
            const token = localStorage.getItem('userToken');
            if (token) {
                // Si hay un token, verificar la sesi√≥n
                verifySession(token);
            }

            // Eventos de login/registro
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Tabs de login/registro
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.addEventListener('click', () => switchLoginTab(tab.dataset.tab));
            });
        }

        /**
         * Verifica el token de sesi√≥n
         */
        async function verifySession(token) {
            try {
                const user = await fetchAPI('/auth/me');
                currentUser = user;
                showMainApp();
            } catch (error) {
                console.error("Error al verificar la sesi√≥n:", error);
                localStorage.removeItem('userToken');
                showLoginPage();
            }
        }

        /**
         * Cambia entre tabs de login y registro
         */
        function switchLoginTab(tab) {
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
        }

        /**
         * Maneja el proceso de login
         */
        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const data = await fetchAPI('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                localStorage.setItem('userToken', data.token);
                currentUser = data.user;
                showMainApp();
                showToast('¬°Bienvenido! Has iniciado sesi√≥n correctamente.', 'success');
            } catch (error) {
                showToast(`Error al iniciar sesi√≥n: ${error.message}`, 'error');
            }
        }

        /**
         * Maneja el proceso de registro
         */
        async function handleRegister(e) {
            e.preventDefault();

            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const university = document.getElementById('registerUniversity').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showToast('Las contrase√±as no coinciden.', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('La contrase√±a debe tener al menos 6 caracteres.', 'error');
                return;
            }

            try {
                const data = await fetchAPI('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, university, password })
                });

                localStorage.setItem('userToken', data.token);
                currentUser = data.user;
                showMainApp();
                showToast('¬°Registro exitoso! Has iniciado sesi√≥n autom√°ticamente.', 'success');
            } catch (error) {
                showToast(`Error al registrarse: ${error.message}`, 'error');
            }
        }

        /**
         * Maneja el logout del usuario
         */
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('userToken');
            showLoginPage();
            showToast('Has cerrado sesi√≥n correctamente.', 'success');
        }

        /**
         * Muestra la p√°gina de login
         */
        function showLoginPage() {
            document.getElementById('loginPage').classList.add('active');
            document.getElementById('mainApp').classList.remove('active');
        }

        /**
         * Muestra la aplicaci√≥n principal
         */
        function showMainApp() {
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');
            initMainApp();
        }





        /**
         * Carga un script de forma asincr√≥nica.
         * @param {string} src La URL del script.
         */
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }







        // ==========================================
        // NAVEGACI√ìN PRINCIPAL
        // ==========================================

        /**
         * Inicializa la aplicaci√≥n principal y sus eventos
         */

        function initMainApp() {
            // Inicializar cache de reportes
            window.reportesCache = [];
   // AGREGAR ESTA L√çNEA:
    configurarEliminarLista();
            document.querySelectorAll('.nav-btn[data-page]').forEach(btn => {
                btn.addEventListener('click', () => {
                    navigateToPage(btn.dataset.page);
                    // Cargar reportes cuando se navega a la p√°gina de reportes guardados
                    if (btn.dataset.page === 'reportes-guardados') {
                        setTimeout(cargarReportesGuardados, 100);
                    }
                });
            });

              // Agregar listener para eliminar lista
    //document.getElementById('confirmarEliminarLista').addEventListener('click', eliminarListaCompleta);

 // Conectar el bot√≥n de confirmaci√≥n del modal a la funci√≥n de eliminaci√≥n
    const confirmarEliminarListaBtn = document.getElementById('confirmarEliminarLista');
    if (confirmarEliminarListaBtn) {
        confirmarEliminarListaBtn.addEventListener('click', eliminarListaCompleta);
    }
 
            initReportForm();
            initReportList();
            initMassUpload();
            loadLists();

            // Cargar reportes al inicializar
            setTimeout(cargarReportesGuardados, 500);
        }


        /**
         * Navega entre las p√°ginas principales de la aplicaci√≥n (ACTUALIZADO)
         */
        function navigateToPage(page) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            document.querySelectorAll('#mainApp .page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');

            // Cargar datos espec√≠ficos de la p√°gina
            if (page === 'reportes-guardados') {
                // Asegurar que los reportes est√©n cargados
                if (!window.reportesCache || window.reportesCache.length === 0) {
                    cargarReportesGuardados();
                }
            }
        }


        // ==========================================
        // FORMULARIO DE REPORTE - INICIALIZACI√ìN
        // ==========================================

        /**
         * Inicializa el formulario de nuevo reporte y sus eventos
         */
        function initReportForm() {
            document.getElementById('fecha').valueAsDate = new Date();
            if (currentUser) {
                document.getElementById('nombreDocente').value = currentUser.name;
                document.getElementById('universidad').value = currentUser.university;
            }

            document.getElementById('agregarNivel').addEventListener('click', agregarNivel);
            document.getElementById('restablecerNiveles').addEventListener('click', restablecerNiveles);
            document.getElementById('agregarCriterio').addEventListener('click', () => abrirModalCriterio());
            document.getElementById('generarPreview').addEventListener('click', generarPreview);
            document.getElementById('puntosAdicionalesCheck').addEventListener('change', togglePuntosAdicionales);

            initModalEvents();
            initCalculationEvents();
            loadNivelesDesempeno();
        }

        /**
         * Inicializa eventos de los modales
         */
        function initModalEvents() {
            document.getElementById('criterioForm').addEventListener('submit', guardarCriterio);
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', cerrarModales);
            });
            document.getElementById('editarReporte').addEventListener('click', cerrarModales);
            document.getElementById('guardarReporte').addEventListener('click', () => abrirModalGuardar());
            document.getElementById('descargarPDF').addEventListener('click', descargarReportePDF);
            document.getElementById('confirmarGuardar').addEventListener('click', confirmarGuardarReporte);
            document.getElementById('usarComoPlantilla').addEventListener('click', usarComoPlantilla);
            document.getElementById('descargarPDFReporte').addEventListener('click', descargarReporteGuardadoPDF);
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) cerrarModales();
                });
            });
        }

        /**
         * Inicializa eventos para c√°lculos autom√°ticos
         */
        function initCalculationEvents() {
            document.addEventListener('change', (e) => {
                if (e.target.matches('.criteria-evaluation')) {
                    calcularNotaFinal();
                }
            });
            ['notaMinima', 'notaMaxima', 'notaAprobacion', 'exigencia'].forEach(id => {
                document.getElementById(id).addEventListener('input', calcularNotaFinal);
            });
        }

        // ==========================================
        // GESTI√ìN DE NIVELES DE DESEMPE√ëO
        // ==========================================

        /**
         * Carga y renderiza los niveles de desempe√±o
         */
        function loadNivelesDesempeno() {
            const container = document.getElementById('nivelesDesempeno');
            container.innerHTML = '';

            nivelesDesempeno.forEach((nivel, index) => {
                const levelDiv = document.createElement('div');
                levelDiv.className = 'level-item';
                levelDiv.innerHTML = `
                    <input type="text" class="form-control" value="${nivel.nombre}" 
                           onchange="actualizarNivel(${index}, 'nombre', this.value)">
                    <input type="number" class="form-control" value="${nivel.puntaje}" min="0" 
                           onchange="actualizarNivel(${index}, 'puntaje', this.value)">
                    <div class="level-actions">
                        <button type="button" class="btn btn-secondary" onclick="moverNivel(${index}, -1)" 
                                ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                        <button type="button" class="btn btn-secondary" onclick="moverNivel(${index}, 1)" 
                                ${index === nivelesDesempeno.length - 1 ? 'disabled' : ''}>‚Üì</button>
                        <button type="button" class="btn btn-danger" onclick="eliminarNivel(${index})" 
                                ${nivelesDesempeno.length <= 2 ? 'disabled' : ''}>üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(levelDiv);
            });

            actualizarSelectoresEvaluacion();
        }

        /**
         * Actualiza un nivel de desempe√±o espec√≠fico
         */
        function actualizarNivel(index, campo, valor) {
            if (campo === 'puntaje') {
                nivelesDesempeno[index][campo] = parseFloat(valor) || 0;
            } else {
                nivelesDesempeno[index][campo] = valor;
            }
            actualizarSelectoresEvaluacion();
            calcularNotaFinal();
        }

        /**
         * Mueve un nivel de desempe√±o hacia arriba o abajo
         */
        function moverNivel(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < nivelesDesempeno.length) {
                [nivelesDesempeno[index], nivelesDesempeno[newIndex]] =
                    [nivelesDesempeno[newIndex], nivelesDesempeno[index]];
                loadNivelesDesempeno();
            }
        }

        /**
         * Elimina un nivel de desempe√±o
         */
        function eliminarNivel(index) {
            if (nivelesDesempeno.length > 2) {
                nivelesDesempeno.splice(index, 1);
                loadNivelesDesempeno();
            } else {
                showMessageDialog('Atenci√≥n', 'Deben existir al menos dos niveles de desempe√±o.');
            }
        }

        /**
         * Agrega un nuevo nivel de desempe√±o
         */
        function agregarNivel() {
            const maxPuntaje = Math.max(...nivelesDesempeno.map(n => n.puntaje));
            nivelesDesempeno.push({
                nombre: `Nivel ${nivelesDesempeno.length + 1}`,
                puntaje: maxPuntaje + 1
            });
            loadNivelesDesempeno();
        }

        /**
         * Restablece los niveles predeterminados
         */
        function restablecerNiveles() {
            nivelesDesempeno = [
                { nombre: 'Insuficiente', puntaje: 0 },
                { nombre: 'Regular', puntaje: 1 },
                { nombre: 'Bueno', puntaje: 2 },
                { nombre: 'Excelente', puntaje: 3 }
            ];
            loadNivelesDesempeno();
        }

        /**
         * Actualiza los selectores de evaluaci√≥n en la tabla de criterios
         */
        function actualizarSelectoresEvaluacion() {
            document.querySelectorAll('.criteria-evaluation').forEach(select => {
                const valorActual = select.value;
                select.innerHTML = '<option value="">Seleccionar...</option>';

                nivelesDesempeno.forEach(nivel => {
                    const option = document.createElement('option');
                    option.value = nivel.puntaje;
                    option.textContent = `${nivel.nombre} (${nivel.puntaje} pts)`;
                    if (valorActual == nivel.puntaje) option.selected = true;
                    select.appendChild(option);
                });
            });
        }

        // ==========================================
        // GESTI√ìN DE CRITERIOS
        // ==========================================

        /**
         * Abre el modal para agregar un nuevo criterio
         */
        function abrirModalCriterio(criterio = null) {
            const modal = document.getElementById('criterioModal');
            const title = document.getElementById('criterioModalTitle');
            const form = document.getElementById('criterioForm');

            if (criterio) {
                title.textContent = 'Editar Criterio';
                document.getElementById('criterioNombre').value = criterio.nombre;
                document.getElementById('criterioExcelente').value = criterio.excelente;
                document.getElementById('criterioBueno').value = criterio.bueno;
                document.getElementById('criterioRegular').value = criterio.regular;
                document.getElementById('criterioInsuficiente').value = criterio.insuficiente;
                form.dataset.editIndex = criterio.index;
            } else {
                title.textContent = 'Agregar Criterio';
                form.reset();
                delete form.dataset.editIndex;
            }

            modal.classList.add('active');
        }

        /**
         * Guarda un criterio (nuevo o editado)
         */
        function guardarCriterio(e) {
            e.preventDefault();

            const form = e.target;
            const criterio = {
                nombre: document.getElementById('criterioNombre').value,
                excelente: document.getElementById('criterioExcelente').value,
                bueno: document.getElementById('criterioBueno').value,
                regular: document.getElementById('criterioRegular').value,
                insuficiente: document.getElementById('criterioInsuficiente').value,
                evaluacion: ''
            };

            if (form.dataset.editIndex !== undefined) {
                const index = parseInt(form.dataset.editIndex);
                const tbody = document.querySelector('#criteriosTable tbody');
                const row = tbody.children[index];
                actualizarFilaCriterio(row, criterio, index);
            } else {
                agregarFilaCriterio(criterio);
            }

            cerrarModales();
            showToast('Criterio guardado exitosamente.', 'success');
        }

        /**
         * Agrega una nueva fila de criterio a la tabla
         */
        function agregarFilaCriterio(criterio) {
            const tbody = document.querySelector('#criteriosTable tbody');
            const row = document.createElement('tr');
            const index = tbody.children.length;

            row.innerHTML = `
                <td><div style="font-weight: 600;">${criterio.nombre}</div></td>
                <td><small>${criterio.excelente}</small></td>
                <td><small>${criterio.bueno}</small></td>
                <td><small>${criterio.regular}</small></td>
                <td><small>${criterio.insuficiente}</small></td>
                <td>
                    <select class="criteria-evaluation">
                        <option value="">Seleccionar...</option>
                    </select>
                </td>
                <td>
                    <button type="button" class="btn btn-secondary" onclick="editarCriterio(${index})" 
                            style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">‚úèÔ∏è</button>
                    <button type="button" class="btn btn-danger" onclick="eliminarCriterio(${index})" 
                            style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">üóëÔ∏è</button>
                </td>
            `;

            tbody.appendChild(row);

            const select = row.querySelector('.criteria-evaluation');
            nivelesDesempeno.forEach(nivel => {
                const option = document.createElement('option');
                option.value = nivel.puntaje;
                option.textContent = `${nivel.nombre} (${nivel.puntaje} pts)`;
                select.appendChild(option);
            });
            if (criterio.evaluacion !== undefined && select.querySelector(`option[value="${criterio.evaluacion}"]`)) {
                select.value = criterio.evaluacion;
            }

            select.addEventListener('change', calcularNotaFinal);
        }

        /**
         * Actualiza una fila de criterio existente
         */
        function actualizarFilaCriterio(row, criterio, index) {
            const currentEvaluation = row.querySelector('.criteria-evaluation').value;

            row.innerHTML = `
                <td><div style="font-weight: 600;">${criterio.nombre}</div></td>
                <td><small>${criterio.excelente}</small></td>
                <td><small>${criterio.bueno}</small></td>
                <td><small>${criterio.regular}</small></td>
                <td><small>${criterio.insuficiente}</small></td>
                <td>
                    <select class="criteria-evaluation">
                        <option value="">Seleccionar...</option>
                    </select>
                </td>
                <td>
                    <button type="button" class="btn btn-secondary" onclick="editarCriterio(${index})" 
                            style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">‚úèÔ∏è</button>
                    <button type="button" class="btn btn-danger" onclick="eliminarCriterio(${index})" 
                            style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">üóëÔ∏è</button>
                </td>
            `;

            const select = row.querySelector('.criteria-evaluation');
            nivelesDesempeno.forEach(nivel => {
                const option = document.createElement('option');
                option.value = nivel.puntaje;
                option.textContent = `${nivel.nombre} (${nivel.puntaje} pts)`;
                if (currentEvaluation == nivel.puntaje) option.selected = true;
                select.appendChild(option);
            });

            select.addEventListener('change', calcularNotaFinal);
        }

        /**
         * Edita un criterio existente
         */
        function editarCriterio(index) {
            const tbody = document.querySelector('#criteriosTable tbody');
            const row = tbody.children[index];
            const cells = row.querySelectorAll('td');

            const criterio = {
                index: index,
                nombre: cells[0].querySelector('div').textContent,
                excelente: cells[1].querySelector('small').textContent,
                bueno: cells[2].querySelector('small').textContent,
                regular: cells[3].querySelector('small').textContent,
                insuficiente: cells[4].querySelector('small').textContent
            };

            abrirModalCriterio(criterio);
        }

        /**
         * Elimina un criterio de la tabla
         */
        async function eliminarCriterio(index) {
            const confirmed = await showCustomDialog('Confirmar eliminaci√≥n', '¬øEst√° seguro de eliminar este criterio?');
            if (confirmed) {
                const tbody = document.querySelector('#criteriosTable tbody');
                tbody.deleteRow(index);

                Array.from(tbody.children).forEach((row, newIndex) => {
                    const editBtn = row.querySelector('button[onclick*="editarCriterio"]');
                    const deleteBtn = row.querySelector('button[onclick*="eliminarCriterio"]');
                    if (editBtn) editBtn.setAttribute('onclick', `editarCriterio(${newIndex})`);
                    if (deleteBtn) deleteBtn.setAttribute('onclick', `eliminarCriterio(${newIndex})`);
                });

                calcularNotaFinal();
                showToast('Criterio eliminado.', 'success');
            }
        }

        // ==========================================
        // C√ÅLCULO DE NOTAS
        // ==========================================

        /**
         * Calcula la nota final basada en los criterios evaluados
         */
        function calcularNotaFinal() {
            const evaluaciones = document.querySelectorAll('.criteria-evaluation');
            let puntajeTotal = 0;
            let criteriosEvaluados = 0;
            let puntajeMaximo = 0;

            evaluaciones.forEach(select => {
                const puntaje = parseFloat(select.value);
                if (!isNaN(puntaje)) {
                    puntajeTotal += puntaje;
                    criteriosEvaluados++;
                }
                const maxPuntajeNivel = Math.max(...nivelesDesempeno.map(n => n.puntaje));
                puntajeMaximo += maxPuntajeNivel;
            });

            if (criteriosEvaluados === 0) {
                window.calculoActual = null;
                return;
            }

            const notaMinima = parseFloat(document.getElementById('notaMinima').value) || 1.0;
            const notaMaxima = parseFloat(document.getElementById('notaMaxima').value) || 7.0;
            const notaAprobacion = parseFloat(document.getElementById('notaAprobacion').value) || 4.0;
            const exigencia = parseFloat(document.getElementById('exigencia').value) || 60;

            const porcentajeLogro = (puntajeTotal / puntajeMaximo) * 100;

            let notaFinal;
            if (porcentajeLogro >= exigencia) {
                const factorExtra = (porcentajeLogro - exigencia) / (100 - exigencia);
                notaFinal = notaAprobacion + (factorExtra * (notaMaxima - notaAprobacion));
            } else {
                const factorBase = porcentajeLogro / exigencia;
                notaFinal = notaMinima + (factorBase * (notaAprobacion - notaMinima));
            }

            const puntosAdicionalesCheck = document.getElementById('puntosAdicionalesCheck');
            const puntosAgregar = parseFloat(document.getElementById('puntosAgregar').value) || 0;

            if (puntosAdicionalesCheck.checked && puntosAgregar > 0) {
                notaFinal += puntosAgregar;
            }

            notaFinal = Math.max(notaMinima, Math.min(notaMaxima, notaFinal));

            window.calculoActual = {
                puntajeTotal,
                puntajeMaximo,
                porcentajeLogro,
                notaFinal: Math.round(notaFinal * 10) / 10,
                criteriosEvaluados
            };
        }

        /**
         * Toggle para mostrar/ocultar secci√≥n de puntos adicionales
         */
        function togglePuntosAdicionales() {
            const checkbox = document.getElementById('puntosAdicionalesCheck');
            const section = document.getElementById('puntosAdicionalesSection');

            if (checkbox.checked) {
                calcularNotaFinal();
                const notaMaxima = parseFloat(document.getElementById('notaMaxima').value) || 7.0;

                if (window.calculoActual && window.calculoActual.notaFinal >= notaMaxima) {
                    showMessageDialog('Atenci√≥n', 'El estudiante ya alcanz√≥ la nota m√°xima. No se pueden agregar puntos adicionales.');
                    checkbox.checked = false;
                    return;
                }

                section.style.display = 'block';
            } else {
                section.style.display = 'none';
                document.getElementById('puntosAgregar').value = '';
                document.getElementById('justificacionPuntos').value = '';
            }
        }

        // ==========================================
        // VISTA PREVIA Y GENERACI√ìN DE REPORTES
        // ==========================================

        /**
         * Genera la vista previa del reporte
         */
        function generarPreview() {
            if (!validarFormulario()) {
                showToast('Por favor complete todos los campos obligatorios.', 'error');
                return;
            }

            calcularNotaFinal();

            if (!window.calculoActual || window.calculoActual.criteriosEvaluados === 0) {
                showToast('Debe evaluar al menos un criterio.', 'error');
                return;
            }

            const reportData = recopilarDatosFormulario();
            currentReport = reportData;

            const reportHTML = generarHTMLReporte(reportData);
            document.getElementById('reportPreviewContent').innerHTML = reportHTML;

            document.getElementById('previewModal').classList.add('active');
        }

        /**
         * Valida que los campos obligatorios est√©n completos
         */
        function validarFormulario() {
            const requiredFields = [
                'nombreEstudiante', 'fecha', 'nombreDocente', 'asignatura',
                'carrera', 'universidad', 'tituloEvaluacion'
            ];

            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    return false;
                }
            }

            const puntosCheck = document.getElementById('puntosAdicionalesCheck');
            if (puntosCheck.checked) {
                const puntos = document.getElementById('puntosAgregar').value;
                const justificacion = document.getElementById('justificacionPuntos').value;

                if (!puntos || !justificacion.trim()) {
                    showToast('Si activa puntos adicionales, debe especificar la cantidad y justificaci√≥n.', 'error');
                    return false;
                }
            }

            return true;
        }

        /**
         * Recopila todos los datos del formulario
         */
        function recopilarDatosFormulario() {
            const infoGeneral = {
                nombreEstudiante: document.getElementById('nombreEstudiante').value,
                fecha: document.getElementById('fecha').value,
                nombreDocente: document.getElementById('nombreDocente').value,
                asignatura: document.getElementById('asignatura').value,
                carrera: document.getElementById('carrera').value,
                universidad: document.getElementById('universidad').value,
                tituloEvaluacion: document.getElementById('tituloEvaluacion').value,
                descripcionEvaluacion: document.getElementById('descripcionEvaluacion').value
            };

            const configuracion = {
                notaMinima: parseFloat(document.getElementById('notaMinima').value),
                notaMaxima: parseFloat(document.getElementById('notaMaxima').value),
                notaAprobacion: parseFloat(document.getElementById('notaAprobacion').value),
                exigencia: parseFloat(document.getElementById('exigencia').value),
                incremento: parseFloat(document.getElementById('incremento').value) || 0.1
            };

            const criterios = [];
            const tbody = document.querySelector('#criteriosTable tbody');

            Array.from(tbody.children).forEach((row) => {
                const cells = row.querySelectorAll('td');
                const evaluacionSelect = cells[5].querySelector('select');
                const evaluacionValue = evaluacionSelect.value;

                if (evaluacionValue !== '') {
                    const nivelSeleccionado = nivelesDesempeno.find(n => n.puntaje == evaluacionValue);

                    criterios.push({
                        nombre: cells[0].querySelector('div').textContent,
                        excelente: cells[1].querySelector('small').textContent,
                        bueno: cells[2].querySelector('small').textContent,
                        regular: cells[3].querySelector('small').textContent,
                        insuficiente: cells[4].querySelector('small').textContent,
                        evaluacion: evaluacionValue,
                        nivelAlcanzado: nivelSeleccionado ? nivelSeleccionado.nombre : ''
                    });
                }
            });

            const feedback = {
                comentario: document.getElementById('feedbackDocente').value,
                puntosAdicionales: document.getElementById('puntosAdicionalesCheck').checked,
                puntosAgregar: parseFloat(document.getElementById('puntosAgregar').value) || 0,
                justificacionPuntos: document.getElementById('justificacionPuntos').value
            };

            const resultados = window.calculoActual || {};

            return {
                id: document.getElementById('reportForm').dataset.editId || crypto.randomUUID(),
                infoGeneral,
                configuracion,
                nivelesDesempeno: [...nivelesDesempeno],
                criterios,
                feedback,
                resultados,
                fechaCreacion: new Date().toISOString(),
                usuarioId: currentUser.id
            };
        }

        /**
         * Genera el HTML del reporte para vista previa
         */
        function generarHTMLReporte(data) {
            const { infoGeneral, criterios, feedback, resultados } = data;

            return `
                <div class="report-header">
                    <h1 class="report-title">Reporte de Evaluaci√≥n</h1>
                    <div style="color: #718096;">
                        <strong>Evaluaci√≥n / Taller:</strong> ${infoGeneral.tituloEvaluacion || 'No especificada'}
                    </div>
                </div>

                <div class="report-info">
                    <div>
                        <div class="report-info-item">
                            <span class="report-info-label">Estudiante:</span>
                            <span>${infoGeneral.nombreEstudiante}</span>
                        </div>
                        <div class="report-info-item">
                            <span class="report-info-label">Carrera:</span>
                            <span>${infoGeneral.carrera}</span>
                        </div>
                        <div class="report-info-item">
                            <span class="report-info-label">Asignatura:</span>
                            <span>${infoGeneral.asignatura}</span>
                        </div>
                        <div class="report-info-item">
                            <span class="report-info-label">Universidad:</span>
                            <span>${infoGeneral.universidad}</span>
                        </div>
                    </div>
                    <div>
                        <div class="report-info-item">
                            <span class="report-info-label">Docente:</span>
                            <span>${infoGeneral.nombreDocente}</span>
                        </div>
                        <div class="report-info-item">
                            <span class="report-info-label">Fecha:</span>
                            <span>${new Date(infoGeneral.fecha).toLocaleDateString()}</span>
                        </div>
                        <div class="report-info-item">
                            <span class="report-info-label">Descripci√≥n:</span>
                            <span>${infoGeneral.descripcionEvaluacion || 'No especificada'}</span>
                        </div>
                    </div>
                </div>

                <div class="report-results">
                    <h3>Resultados</h3>
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-value">${resultados.notaFinal || 0}</div>
                            <div class="result-label">Nota Final</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value">${resultados.puntajeTotal || 0} de ${resultados.puntajeMaximo || 0}</div>
                            <div class="result-label">Puntaje Total</div>
                        </div>
                        <div class="result-item">
                            <div class="result-value">${Math.round(resultados.porcentajeLogro || 0)}%</div>
                            <div class="result-label">% de Logro</div>
                        </div>
                    </div>
                </div>

                <div class="criteria-details">
                    <h3>Detalle de Criterios Evaluados</h3>
                    <table class="criteria-table-report">
                        <thead>
                            <tr>
                                <th>Criterio</th>
                                <th>Nivel Alcanzado</th>
                                <th>Excelente (${Math.max(...data.nivelesDesempeno.map(n => n.puntaje))} pts)</th>
                                <th>Bueno</th>
                                <th>Regular</th>
                                <th>Insuficiente (${Math.min(...data.nivelesDesempeno.map(n => n.puntaje))} pts)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${criterios.map(criterio => `
                                <tr>
                                    <td><strong>${criterio.nombre}</strong></td>
                                    <td style="text-align: center;">
                                        <span style="background: #4299e1; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: bold;">
                                            ${criterio.nivelAlcanzado} (${criterio.evaluacion} pts)
                                        </span>
                                    </td>
                                    <td><small>${criterio.excelente}</small></td>
                                    <td><small>${criterio.bueno}</small></td>
                                    <td><small>${criterio.regular}</small></td>
                                    <td><small>${criterio.insuficiente}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="feedback-section">
                    <h3>Feedback del Docente</h3>
                    <p>${feedback.comentario || 'Sin comentarios adicionales.'}</p>
                    
                    ${feedback.puntosAdicionales ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: #e6fffa; border-left: 4px solid #38b2ac; border-radius: 4px;">
                            <strong>‚ú® Puntos Adicionales: +${feedback.puntosAgregar}</strong><br>
                            <strong>Justificaci√≥n:</strong> ${feedback.justificacionPuntos}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ==========================================
        // GESTI√ìN DE REPORTES GUARDADOS
        // ==========================================

        /**
         * Abre el modal para guardar el reporte
         */
        async function abrirModalGuardar() {
            await loadLists();
            document.getElementById('guardarModal').classList.add('active');
        }

        /**
         * Confirma y guarda el reporte en la lista seleccionada
         */
        async function confirmarGuardarReporte() {
            if (!currentReport) {
                showToast('Error: No hay reporte para guardar.', 'error');
                return;
            }

            const listaSeleccionada = document.getElementById('listaExistente').value;
            const nuevaLista = document.getElementById('nuevaLista').value.trim();

            let listaId = listaSeleccionada || null;

            if (nuevaLista) {
                try {
                    const response = await fetchAPI('/lists', {
                        method: 'POST',
                        body: JSON.stringify({ name: nuevaLista })
                    });
                    listaId = response.id;
                    showToast('Nueva lista creada exitosamente.', 'success');
                } catch (error) {
                    showToast(`Error al crear la lista: ${error.message}`, 'error');
                    return;
                }
            }

            try {
                let response;
                if (document.getElementById('reportForm').dataset.editId) {
                    // Actualizar reporte existente
                    response = await fetchAPI(`/reports/${currentReport.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ ...currentReport, listaId })
                    });
                    showToast('Reporte actualizado exitosamente.', 'success');
                } else {
                    // Guardar nuevo reporte
                    response = await fetchAPI('/reports', {
                        method: 'POST',
                        body: JSON.stringify({ ...currentReport, listaId })
                    });
                    showToast('Reporte guardado exitosamente.', 'success');
                }

                cerrarModales();
                document.getElementById('reportForm').reset();
                document.querySelector('#criteriosTable tbody').innerHTML = '';
                delete document.getElementById('reportForm').dataset.editId;
                currentReport = null;

                cargarReportesGuardados();
                loadLists();

            } catch (error) {
                showToast(`Error al guardar el reporte: ${error.message}`, 'error');
            }
        }

        /**
/**
 * Carga las listas disponibles
 */

 
async function loadLists() {
    try {
        const [reportes, listas] = await Promise.all([
            fetchAPI('/reports'),
            fetchAPI('/lists')
        ]);

        console.log('=== Debug loadLists ===');
        console.log('Total reportes:', reportes.length);
        console.log('Total listas en DB:', listas.length);

        // Crear mapa de listas activas y contar reportes por lista
        const listasActivas = new Map();
        const reportesPorLista = new Map();

        reportes.forEach(reporte => {
            const listaId = reporte.listaId || reporte.list_id;
            if (listaId) {
                const lista = listas.find(l => l.id === listaId);
                if (lista) {
                    listasActivas.set(lista.id, lista);
                    reportesPorLista.set(lista.id, (reportesPorLista.get(lista.id) || 0) + 1);
                }
            }
        });

        const listasActivasArray = Array.from(listasActivas.values());

        // Actualizar selectores
        const selects = ['listaExistente', 'filtroLista', 'listaAEliminar'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (!select) return;

            const currentValue = select.value;
            
            // Limpiar select
            select.innerHTML = selectId === 'filtroLista' ? 
                '<option value="">Todas las Listas</option>' : 
                '<option value="">-- Seleccione una lista --</option>';

            // Agregar opciones
            listasActivasArray.forEach(lista => {
                const option = document.createElement('option');
                option.value = lista.id;
                option.textContent = `${lista.name} (${reportesPorLista.get(lista.id)} reportes)`;
                if (currentValue === lista.id.toString()) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        });

        // Agregar bot√≥n de eliminar listas si hay listas activas
        const filterSection = document.querySelector('.filter-row');
        if (filterSection) {
            let eliminarBtn = filterSection.querySelector('#eliminarListasBtn');
            if (!eliminarBtn && listasActivasArray.length > 0) {
                eliminarBtn = document.createElement('button');
                eliminarBtn.id = 'eliminarListasBtn';
                eliminarBtn.className = 'btn btn-danger';
                eliminarBtn.innerHTML = 'üóëÔ∏è Eliminar Listas';
                eliminarBtn.onclick = abrirModalEliminarLista;
                filterSection.appendChild(eliminarBtn);
            } else if (eliminarBtn && listasActivasArray.length === 0) {
                eliminarBtn.remove();
            }
        }

        return listasActivasArray;
    } catch (error) {
        console.error('Error al cargar las listas:', error);
        showToast('Error al cargar las listas', 'error');
        return [];
    }
}


        /**
         * Inicializa la p√°gina de reportes guardados
         */
        function initReportList() {
            document.getElementById('aplicarFiltros').addEventListener('click', aplicarFiltros);
            document.getElementById('busquedaReporte').addEventListener('input', aplicarFiltros);
            document.getElementById('filtroLista').addEventListener('change', aplicarFiltros);
            document.getElementById('descargarListadoPDF').addEventListener('click', descargarListadoCompleto);
        }

        /**
         * Carga y muestra los reportes guardados
         */

        /**
         * Actualizar cargarReportesGuardados para manejar mejor la asignaci√≥n de listas
         */
        async function cargarReportesGuardados() {
            const container = document.getElementById('listaReportes');

            if (window.cargandoReportes) return;
            window.cargandoReportes = true;

            try {
                const [reportes, listas] = await Promise.all([
                    fetchAPI('/reports'),
                    fetchAPI('/lists')
                ]);

                console.log('Reportes cargados:', reportes.length);
                console.log('Listas cargadas:', listas.length);

                // Mapear reportes con informaci√≥n de lista consistente
                const reportesNormalizados = reportes.map(reporte => {
                    const listaId = reporte.listaId || reporte.list_id;
                    const lista = listas.find(l => l.id === listaId);

                    return {
                        ...reporte,
                        listaId: listaId || null,
                        list_id: listaId || null,
                        listaNombre: lista ? lista.name : 'Sin Lista'
                    };
                });

                // Actualizar cach√© con datos normalizados
                window.reportesCache = reportesNormalizados;

                // Renderizar reportes
                if (reportesNormalizados.length === 0) {
                    container.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #718096;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                    <h3>No hay reportes guardados</h3>
                    <p>Los reportes que guarde aparecer√°n aqu√≠.</p>
                </div>
            `;
                    return;
                }

                // Ordenar y renderizar reportes
                container.innerHTML = reportesNormalizados
                    .sort((a, b) => new Date(b.fechaCreacion || b.created_at) - new Date(a.fechaCreacion || a.created_at))
                    .map(reporte => generarCardReporte(reporte))
                    .join('');

                reportesNormalizados.forEach(reporte => {
                    console.log(`Reporte ${reporte.id}: listaId=${reporte.listaId}, listaNombre=${reporte.listaNombre}`);
                });

            } catch (error) {
                console.error('Error al cargar reportes:', error);
                container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #f56565;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†</div>
                <h3>Error al cargar reportes</h3>
                <p>${error.message}</p>
                <button class="btn btn-primary" onclick="cargarReportesGuardados()" style="margin-top: 1rem;">
                    Reintentar
                </button>
            </div>
        `;
            } finally {
                window.cargandoReportes = false;
            }
        }

        /**
         * Genera la tarjeta HTML para un reporte
         */
        function generarCardReporte(reporte) {
            const fecha = new Date(reporte.infoGeneral.fecha).toLocaleDateString();
            const fechaCreacion = new Date(reporte.fechaCreacion).toLocaleDateString();

            return `
                <div class="card reporte-card" data-reporte-id="${reporte.id}">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${reporte.infoGeneral.tituloEvaluacion}</div>
                        </div>
                        <div class="grade-badge">${reporte.resultados.notaFinal || 'N/A'}</div>
                    </div>
                    
                    <div class="card-info">
                        <div class="card-field">
                            <label>Estudiante</label>
                            <span>${reporte.infoGeneral.nombreEstudiante}</span>
                        </div>
                        <div class="card-field">
                            <label>Fecha Evaluaci√≥n</label>
                            <span>${fecha}</span>
                        </div>
                        <div class="card-field">
                            <label>Asignatura</label>
                            <span>${reporte.infoGeneral.asignatura}</span>
                        </div>
                        <div class="card-field">
                            <label>Lista</label>
                            <span style="background: #e2e8f0; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">
                                ${reporte.listaNombre || 'Sin Lista'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="editarReporteGuardado('${reporte.id}')">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="btn btn-primary" onclick="verVistaPrevia('${reporte.id}')">
                            üëÅÔ∏è Vista Previa
                        </button>
                        <button class="btn btn-danger" onclick="eliminarReporte('${reporte.id}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Aplica filtros a la lista de reportes
         */
        function aplicarFiltros() {
            const listaFiltro = document.getElementById('filtroLista').value;
            const busqueda = document.getElementById('busquedaReporte').value.toLowerCase();
            const tarjetas = document.querySelectorAll('.reporte-card');

            tarjetas.forEach(tarjeta => {
                const reporteId = tarjeta.dataset.reporteId;
                const reporte = window.reportesCache.find(r => r.id === reporteId);
                if (!reporte) return;

                let mostrarPorLista = true;
                if (listaFiltro) {
                    mostrarPorLista = reporte.listaId == listaFiltro;
                }

                let mostrarPorBusqueda = true;
                if (busqueda) {
                    const textoReporte = `
                        ${reporte.infoGeneral.nombreEstudiante} 
                        ${reporte.infoGeneral.tituloEvaluacion} 
                        ${reporte.infoGeneral.asignatura}
                    `.toLowerCase();
                    mostrarPorBusqueda = textoReporte.includes(busqueda);
                }

                tarjeta.style.display = (mostrarPorLista && mostrarPorBusqueda) ? 'block' : 'none';
            });
        }

        // ==========================================
        // ACCIONES DE REPORTES GUARDADOS
        // ==========================================

        /**
         * Muestra la vista previa de un reporte guardado
         */
        async function verVistaPrevia(reporteId) {
            try {
                const reporte = await fetchAPI(`/reports/${reporteId}`);
                if (!reporte) {
                    showToast('Reporte no encontrado.', 'error');
                    return;
                }
                const reportHTML = generarHTMLReporte(reporte);
                document.getElementById('vistaReporteContent').innerHTML = reportHTML;
                const modal = document.getElementById('vistaReporteModal');
                modal.dataset.reporteId = reporteId;
                modal.classList.add('active');
            } catch (error) {
                showToast(`Error al cargar la vista previa: ${error.message}`, 'error');
            }
        }

        /**
         * Usa un reporte como plantilla para crear uno nuevo
         */
        async function usarComoPlantilla() {
            const modal = document.getElementById('vistaReporteModal');
            const reporteId = modal.dataset.reporteId;
            try {
                const reporte = await fetchAPI(`/reports/${reporteId}`);
                if (!reporte) {
                    showToast('Reporte no encontrado.', 'error');
                    return;
                }
                cerrarModales();
                navigateToPage('nuevo-reporte');
                setTimeout(() => {
                    rellenarFormularioConPlantilla(reporte);
                    showToast('Plantilla cargada. Modifique los datos necesarios.', 'success');
                }, 100);
            } catch (error) {
                showToast(`Error al cargar la plantilla: ${error.message}`, 'error');
            }
        }

        /**
         * Rellena el formulario con datos de una plantilla
         */
        function rellenarFormularioConPlantilla(reporte) {
            const { infoGeneral, configuracion, nivelesDesempeno: nivelesReporte, criterios } = reporte;
            document.getElementById('reportForm').reset();
            document.querySelector('#criteriosTable tbody').innerHTML = '';
            delete document.getElementById('reportForm').dataset.editId;

            document.getElementById('nombreDocente').value = infoGeneral.nombreDocente;
            document.getElementById('asignatura').value = infoGeneral.asignatura;
            document.getElementById('carrera').value = infoGeneral.carrera;
            document.getElementById('universidad').value = infoGeneral.universidad;
            document.getElementById('descripcionEvaluacion').value = infoGeneral.descripcionEvaluacion || '';

            document.getElementById('notaMinima').value = configuracion.notaMinima;
            document.getElementById('notaMaxima').value = configuracion.notaMaxima;
            document.getElementById('notaAprobacion').value = configuracion.notaAprobacion;
            document.getElementById('exigencia').value = configuracion.exigencia;
            document.getElementById('incremento').value = configuracion.incremento;

            nivelesDesempeno = [...nivelesReporte];
            loadNivelesDesempeno();

            criterios.forEach(criterio => {
                const criterioLimpio = {
                    nombre: criterio.nombre,
                    excelente: criterio.excelente,
                    bueno: criterio.bueno,
                    regular: criterio.regular,
                    insuficiente: criterio.insuficiente
                };
                agregarFilaCriterio(criterioLimpio);
            });
            setTimeout(calcularNotaFinal, 100);
        }

        /**
         * Edita un reporte guardado
         */
        async function editarReporteGuardado(reporteId) {
            try {
                const reporte = await fetchAPI(`/reports/${reporteId}`);
                if (!reporte) {
                    showToast('Reporte no encontrado.', 'error');
                    return;
                }
                navigateToPage('nuevo-reporte');
                setTimeout(() => {
                    rellenarFormularioCompleto(reporte);
                    document.getElementById('reportForm').dataset.editId = reporteId;
                    showToast('Reporte cargado para edici√≥n.', 'success');
                }, 100);
            } catch (error) {
                showToast(`Error al cargar el reporte: ${error.message}`, 'error');
            }
        }

        /**
         * Rellena el formulario completo con todos los datos del reporte
         */
        function rellenarFormularioCompleto(reporte) {
            const { infoGeneral, configuracion, nivelesDesempeno: nivelesReporte, criterios, feedback } = reporte;
            document.getElementById('reportForm').reset();
            document.querySelector('#criteriosTable tbody').innerHTML = '';

            document.getElementById('nombreEstudiante').value = infoGeneral.nombreEstudiante;
            document.getElementById('fecha').value = infoGeneral.fecha;
            document.getElementById('nombreDocente').value = infoGeneral.nombreDocente;
            document.getElementById('asignatura').value = infoGeneral.asignatura;
            document.getElementById('carrera').value = infoGeneral.carrera;
            document.getElementById('universidad').value = infoGeneral.universidad;
            document.getElementById('tituloEvaluacion').value = infoGeneral.tituloEvaluacion;
            document.getElementById('descripcionEvaluacion').value = infoGeneral.descripcionEvaluacion || '';

            document.getElementById('notaMinima').value = configuracion.notaMinima;
            document.getElementById('notaMaxima').value = configuracion.notaMaxima;
            document.getElementById('notaAprobacion').value = configuracion.notaAprobacion;
            document.getElementById('exigencia').value = configuracion.exigencia;
            document.getElementById('incremento').value = configuracion.incremento;

            nivelesDesempeno = [...nivelesReporte];
            loadNivelesDesempeno();

            criterios.forEach(criterio => {
                agregarFilaCriterio(criterio);
                const ultimaFila = document.querySelector('#criteriosTable tbody').lastElementChild;
                const select = ultimaFila.querySelector('.criteria-evaluation');
                if (select && criterio.evaluacion !== undefined) {
                    select.value = criterio.evaluacion;
                }
            });

            document.getElementById('feedbackDocente').value = feedback.comentario || '';
            if (feedback.puntosAdicionales) {
                document.getElementById('puntosAdicionalesCheck').checked = true;
                document.getElementById('puntosAgregar').value = feedback.puntosAgregar;
                document.getElementById('justificacionPuntos').value = feedback.justificacionPuntos;
                document.getElementById('puntosAdicionalesSection').style.display = 'block';
            } else {
                document.getElementById('puntosAdicionalesCheck').checked = false;
                document.getElementById('puntosAdicionalesSection').style.display = 'none';
            }

            setTimeout(calcularNotaFinal, 100);
        }

        /**
         * Elimina un reporte guardado
         */
        async function eliminarReporte(reporteId) {
            const confirmed = await showCustomDialog('Confirmar eliminaci√≥n', '¬øEst√° seguro de eliminar este reporte? Esta acci√≥n no se puede deshacer.');
            if (confirmed) {
                try {
                    await fetchAPI(`/reports/${reporteId}`, { method: 'DELETE' });
                    await cargarReportesGuardados();
                    await loadLists(); // Recargar listas en caso de que se haya eliminado la √∫ltima referencia
                    showToast('Reporte eliminado exitosamente.', 'success');
                } catch (error) {
                    showToast(`Error al eliminar el reporte: ${error.message}`, 'error');
                }
            }
        }



        // ==========================================
        // GENERAR REPORTES PDF
        // ==========================================

        /**
         * Genera y descarga un PDF del elemento especificado
         */
        async function generarPDF(element, fileName) {
            if (!element) {
                showToast('Error: El elemento a generar PDF no existe.', 'error');
                return;
            }

            try {
                // Crear un contenedor temporal con padding
                const container = document.createElement('div');
                container.style.padding = '40px'; // Agregar padding general
                container.style.maxWidth = '800px'; // Limitar el ancho m√°ximo
                container.style.margin = '0 auto'; // Centrar el contenido

                // Clonar el contenido original
                const contentClone = element.cloneNode(true);
                container.appendChild(contentClone);
                document.body.appendChild(container);

                // Ocultar elementos que no queremos en el PDF
                const actionsContainer = container.querySelector('.card-actions, .modal-actions');
                if (actionsContainer) {
                    actionsContainer.style.display = 'none';
                }

                // Asegurarse de que la informaci√≥n general tenga el espaciado correcto
                const reportInfo = container.querySelector('.report-info');
                if (reportInfo) {
                    reportInfo.style.padding = '20px';
                    reportInfo.style.marginBottom = '30px';
                }

                // Generar el canvas con el nuevo contenedor
                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    windowWidth: 800, // Ancho fijo para mejor control
                    width: 800
                });

                // Crear PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                // Calcular dimensiones manteniendo proporciones
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pageWidth / imgWidth, pageHeight / imgHeight);

                // Centrar la imagen en la p√°gina
                const imgX = (pageWidth - (imgWidth * ratio)) / 2;
                const imgY = 20; // Margen superior fijo

                // Agregar imagen al PDF
                pdf.addImage(imgData, 'JPEG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);

                // Guardar PDF
                pdf.save(fileName);
                showToast('PDF generado exitosamente', 'success');

                // Limpiar: remover el contenedor temporal
                document.body.removeChild(container);

            } catch (error) {
                console.error('Error al generar PDF:', error);
                showToast('Error al generar el PDF', 'error');
            }
        }


        /**
         * Descarga el reporte actual como PDF
         */
        async function descargarReportePDF() {
            if (!currentReport) {
                showToast('Error: No hay reporte para descargar.', 'error');
                return;
            }
            const previewContent = document.getElementById('reportPreviewContent');
            const fileName = `reporte_${currentReport.infoGeneral.nombreEstudiante.replace(/ /g, '_')}.pdf`;
            await generarPDF(previewContent, fileName);
        }

        /**
         * Descarga un reporte guardado como PDF
         */
        async function descargarReporteGuardadoPDF() {
            const modal = document.getElementById('vistaReporteModal');
            const reporteContent = document.getElementById('vistaReporteContent');
            const fileName = `reporte_guardado_${Date.now()}.pdf`;
            await generarPDF(reporteContent, fileName);
        }

        /**
         * Genera y descarga el listado de reportes filtrados en PDF
         */
        async function descargarListadoCompleto() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Obtener los filtros actuales
                const listaFiltro = document.getElementById('filtroLista').value;
                const busqueda = document.getElementById('busquedaReporte').value.toLowerCase();

                // Filtrar los reportes del cache seg√∫n los criterios actuales
                const reportesFiltrados = window.reportesCache.filter(reporte => {
                    let cumpleFiltroLista = true;
                    let cumpleBusqueda = true;

                    // Aplicar filtro de lista
                    if (listaFiltro) {
                        cumpleFiltroLista = reporte.listaId == listaFiltro;
                    }

                    // Aplicar filtro de b√∫squeda
                    if (busqueda) {
                        const textoReporte = `
                    ${reporte.infoGeneral.nombreEstudiante} 
                    ${reporte.infoGeneral.tituloEvaluacion} 
                    ${reporte.infoGeneral.asignatura}
                `.toLowerCase();
                        cumpleBusqueda = textoReporte.includes(busqueda);
                    }

                    return cumpleFiltroLista && cumpleBusqueda;
                });

                if (reportesFiltrados.length === 0) {
                    showToast('No hay reportes que cumplan con los filtros actuales.', 'info');
                    return;
                }

                // Configurar el t√≠tulo
                doc.setFontSize(16);
                doc.text("Listado de Reportes de Evaluaci√≥n", 15, 15);

                // Agregar informaci√≥n de los filtros aplicados
                if (listaFiltro) {
                    const listaSeleccionada = document.querySelector('#filtroLista option:checked').textContent;
                    doc.setFontSize(10);
                    doc.text(`Lista: ${listaSeleccionada}`, 15, 25);
                }
                if (busqueda) {
                    doc.setFontSize(10);
                    doc.text(`B√∫squeda: "${busqueda}"`, 15, listaFiltro ? 32 : 25);
                }

                // Preparar los datos para la tabla
                const headers = [['Estudiante', 'Evaluaci√≥n', 'Fecha', 'Nota', 'Asignatura']];
                const data = reportesFiltrados.map(r => [
                    r.infoGeneral.nombreEstudiante,
                    r.infoGeneral.tituloEvaluacion,
                    new Date(r.infoGeneral.fecha).toLocaleDateString(),
                    r.resultados.notaFinal,
                    r.infoGeneral.asignatura
                ]);

                // Generar la tabla
                doc.autoTable({
                    head: headers,
                    body: data,
                    startY: (listaFiltro || busqueda) ? 40 : 25,
                    theme: 'grid',
                    styles: {
                        fontSize: 8,
                        cellPadding: 3
                    },
                    headStyles: {
                        fillColor: [66, 139, 202]
                    },
                    footStyles: {
                        fillColor: [60, 60, 60]
                    },
                    // Agregar totales al pie de la tabla
                    foot: [[
                        'Total Reportes:',
                        `${reportesFiltrados.length} reportes`,
                        '',
                        `Promedio: ${(reportesFiltrados.reduce((sum, r) => sum + r.resultados.notaFinal, 0) / reportesFiltrados.length).toFixed(1)}`,
                        ''
                    ]]
                });

                // Generar nombre del archivo seg√∫n los filtros
                let fileName = 'listado_reportes';
                if (listaFiltro) {
                    const listaSeleccionada = document.querySelector('#filtroLista option:checked').textContent;
                    fileName += `_${listaSeleccionada.replace(/ /g, '_')}`;
                }
                fileName += '.pdf';

                doc.save(fileName);
                showToast('Listado PDF generado exitosamente', 'success');
            } catch (error) {
                console.error('Error al generar listado PDF:', error);
                showToast('Error al generar el listado PDF', 'error');
            }
        }

        // ==========================================
        // CARGA MASIVA
        // ==========================================

        /**
         * Inicializa la funcionalidad de carga masiva
         */
        function initMassUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('csvFile');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);

            document.getElementById('descargarPlantilla').addEventListener('click', descargarPlantillaCSV);
            document.getElementById('procesarCSV').addEventListener('click', procesarArchivoCSV);
        }

        /**
         * Maneja el evento dragover para el √°rea de carga
         */
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        /**
         * Maneja el evento dragleave para el √°rea de carga
         */
        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        /**
         * Maneja el evento drop para el √°rea de carga
         */
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleSelectedFile(files[0]);
            }
        }

        /**
         * Maneja la selecci√≥n de archivo
         */
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleSelectedFile(file);
            }
        }

        /**
         * Procesa el archivo seleccionado
         */
        function handleSelectedFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showToast('Por favor seleccione un archivo CSV v√°lido.', 'error');
                return;
            }

            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 1rem; color: #48bb78;">‚úì</div>
                <p><strong>Archivo seleccionado:</strong> ${file.name}</p>
                <p style="color: #718096; font-size: 0.875rem;">Tama√±o: ${(file.size / 1024).toFixed(2)} KB</p>
            `;
            document.getElementById('procesarCSV').disabled = false;
            window.selectedCSVFile = file;
        }

        /**
         * Descarga la plantilla CSV
         */
        function descargarPlantillaCSV() {
            const headers = [
                'nombreEstudiante',
                'fecha',
                'nombreDocente',
                'asignatura',
                'carrera',
                'universidad',
                'tituloEvaluacion',
                'descripcionEvaluacion',
                'lista',
                'criterio1_nombre',
                'criterio1_evaluacion',
                'criterio2_nombre',
                'criterio2_evaluacion',
                'criterio3_nombre',
                'criterio3_evaluacion',
                'feedbackDocente',
                'puntosAdicionales',
                'puntosAgregar',
                'justificacionPuntos'
            ];

            // Usar tabulaci√≥n como separador
            const csvContent = headers.join('\t') + '\n' +
                'Juan P√©rez\t2024-03-15\tMar√≠a Gonz√°lez\tMatem√°ticas\tIngenier√≠a\tUniversidad ABC\t' +
                'Examen Final\tEvaluaci√≥n b√°sica\tGrupo A\tResoluci√≥n de Problemas\t3\t' +
                'Participaci√≥n en Clase\t2\tTrabajo en Equipo\t3\tExcelente desempe√±o\tfalse\t0\t';

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'plantilla_reportes.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showToast('Plantilla CSV descargada exitosamente.', 'success');
        }

        /**
      * Procesa el archivo CSV subido
      */
        async function procesarArchivoCSV() {
            if (!window.selectedCSVFile) {
                showToast('Por favor seleccione un archivo CSV primero.', 'error');
                return;
            }

            try {
                const fileContent = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(window.selectedCSVFile);
                });

                // Parsear CSV y generar reportes
                const reportesGenerados = await parsearCSV(fileContent);

                if (reportesGenerados && reportesGenerados.length > 0) {
                    await procesarReportesMasivos(reportesGenerados);
                } else {
                    showToast('No se encontraron datos v√°lidos en el archivo CSV.', 'error');
                }
            } catch (error) {
                console.error('Error procesando CSV:', error);
                showToast('Error al procesar el archivo: ' + error.message, 'error');
            }
        }

        /**
         * Parsea el contenido CSV y genera reportes
         */

        async function parsearCSV(csvContent) {
            try {
                // Detectar el separador (coma o tabulaci√≥n)
                const primeraLinea = csvContent.split('\n')[0];
                const separador = primeraLinea.includes('\t') ? '\t' : ',';

                // Preprocesar el contenido para manejar saltos de l√≠nea en campos
                let contenidoProcesado = csvContent
                    .replace(/"\s*\n\s*"/g, ' ') // Reemplazar saltos de l√≠nea dentro de comillas por espacios
                    .replace(/\r\n/g, '\n') // Normalizar saltos de l√≠nea
                    .replace(/\r/g, '\n');

                // Dividir por l√≠neas y limpiar
                const lineas = contenidoProcesado.split('\n')
                    .map(linea => linea.trim())
                    .filter(linea => linea.length > 0);

                if (lineas.length < 2) {
                    throw new Error('El archivo debe tener al menos una fila de encabezados y una fila de datos.');
                }

                // Procesar encabezados
                const headers = lineas[0].split(separador).map(h => h.trim());
                console.log('Headers detectados:', headers);
                console.log('N√∫mero esperado de campos:', headers.length);

                const reportesGenerados = [];
                let reportesProcesados = 0;
                let reportesConError = 0;
                let errores = [];

                // Procesar cada l√≠nea de datos
                for (let i = 1; i < lineas.length; i++) {
                    try {
                        let valores = lineas[i].split(separador);

                        // Verificar y ajustar el n√∫mero de campos
                        if (valores.length !== headers.length) {
                            console.warn(`L√≠nea ${i + 1}: se encontraron ${valores.length} campos, se esperaban ${headers.length}`);

                            // Si hay menos campos, rellenar con valores vac√≠os
                            while (valores.length < headers.length) {
                                valores.push('');
                            }
                            // Si hay m√°s campos, truncar
                            if (valores.length > headers.length) {
                                valores = valores.slice(0, headers.length);
                            }
                        }

                        // Limpiar valores
                        valores = valores.map(v => v.trim().replace(/^["']|["']$/g, ''));

                        // Validar campos cr√≠ticos
                        const camposCriticos = ['nombreEstudiante', 'fecha', 'nombreDocente', 'asignatura', 'carrera'];
                        const indicesCriticos = camposCriticos.map(campo => headers.indexOf(campo));
                        const tieneValoresCriticos = indicesCriticos.every(index => index >= 0 && valores[index]);

                        if (tieneValoresCriticos) {
                            const reporte = await generarReporteDesdeCSV(headers, valores);
                            if (reporte) {
                                reportesGenerados.push(reporte);
                                reportesProcesados++;
                                console.log(`Procesado correctamente: ${valores[0]}`);
                            }
                        } else {
                            const error = `Fila ${i + 1}: faltan campos obligatorios`;
                            errores.push(error);
                            reportesConError++;
                        }
                    } catch (error) {
                        const mensajeError = `Error en fila ${i + 1}: ${error.message}`;
                        errores.push(mensajeError);
                        console.warn(mensajeError);
                        reportesConError++;
                    }
                }

                // Mostrar resumen detallado
                console.log(`
Resumen de procesamiento:
------------------------
Total de filas: ${lineas.length - 1}
Reportes procesados exitosamente: ${reportesProcesados}
Reportes con error: ${reportesConError}
------------------------
Errores encontrados:
${errores.join('\n')}
        `);

                if (reportesGenerados.length === 0) {
                    throw new Error('No se pudo procesar ning√∫n reporte del archivo.');
                }

                // Agregar esto al final de la funci√≥n procesarArchivoCSV
                if (reportesGenerados.length < lineas.length - 1) {
                    showToast(`Advertencia: Solo se procesaron ${reportesGenerados.length} de ${lineas.length - 1} registros. Revise la consola para m√°s detalles.`, 'warning');
                }
 console.log('\n=== Resumen de Procesamiento ===');
        console.log(`Total l√≠neas procesadas: ${lineas.length - 1}`);
        console.log(`Reportes generados exitosamente: ${reportesProcesados}`);
        console.log(`Reportes con error: ${reportesConError}`);
        console.log('Errores encontrados:', errores);

                return reportesGenerados;

            } catch (error) {
                console.error('Error al parsear CSV:', error);
                throw new Error(`Error al procesar el archivo: ${error.message}`);
            }
        }


// Remover este bloque que est√° suelto y causando el error
// if (reportesInvalidos > 0) {
//     showToast(`Advertencia: ${reportesInvalidos} reportes fueron omitidos por datos inv√°lidos`, 'warning');
// }


/**
 * Procesa los reportes generados masivamente
 */
async function procesarReportesMasivos(reportesNuevos) {
    if (!Array.isArray(reportesNuevos) || reportesNuevos.length === 0) {
        throw new Error('No hay reportes v√°lidos para procesar');
    }

    const sobrescribir = document.getElementById('sobrescribirReportes').checked;
    let reportesActualizados = 0;
    let reportesNuevosCount = 0;
    const listasProcesadas = new Set();
    let reportesInvalidos = 0;

    try {
        // Obtener todos los reportes existentes una sola vez
        const reportesExistentes = await fetchAPI('/reports');

        for (const reporteNuevo of reportesNuevos) {
            if (!reporteNuevo) {
                reportesInvalidos++;
                continue;
            }

            if (!reporteNuevo.infoGeneral) {
                console.warn('Reporte inv√°lido encontrado:', reporteNuevo);
                continue;
            }

            if (reporteNuevo.listaId) {
                listasProcesadas.add(reporteNuevo.listaId);
            }

            // Buscar coincidencia
            const reporteExistente = reportesExistentes.find(r => 
                r.infoGeneral.tituloEvaluacion === reporteNuevo.infoGeneral.tituloEvaluacion &&
                r.infoGeneral.nombreEstudiante === reporteNuevo.infoGeneral.nombreEstudiante
            );

            try {
                if (reporteExistente && sobrescribir) {
                    await fetchAPI(`/reports/${reporteExistente.id}`, {
                        method: 'PUT',
                        body: JSON.stringify(reporteNuevo)
                    });
                    reportesActualizados++;
                } else if (!reporteExistente) {
                    await fetchAPI('/reports', {
                        method: 'POST',
                        body: JSON.stringify(reporteNuevo)
                    });
                    reportesNuevosCount++;
                }
                   console.log('\n=== Resumen Final ===');
        console.log('Reportes procesados:', reportesNuevos.length);
        console.log('Reportes nuevos:', reportesNuevosCount);
        console.log('Reportes actualizados:', reportesActualizados);
        console.log('Reportes inv√°lidos:', reportesInvalidos);
            } catch (error) {
                console.error('Error procesando reporte individual:', error);
            }
        }

        // Mostrar resultados
        const container = document.getElementById('resultadosCarga');
        const estadisticas = document.getElementById('estadisticasCarga');
        estadisticas.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div class="result-item">
                    <div class="result-value">${reportesNuevos.length}</div>
                    <div class="result-label">Reportes Procesados</div>
                </div>
                <div class="result-item">
                    <div class="result-value">${reportesNuevosCount}</div>
                    <div class="result-label">Reportes Nuevos</div>
                </div>
                <div class="result-item">
                    <div class="result-value">${reportesActualizados}</div>
                    <div class="result-label">Reportes Actualizados</div>
                </div>
                <div class="result-item">
                    <div class="result-value">${listasProcesadas.size}</div>
                    <div class="result-label">Listas Procesadas</div>
                </div>
            </div>
            
            <div style="margin-top: 1.5rem;">
                <h4>Resumen de Importaci√≥n:</h4>
                <ul>
                    <li>‚úÖ ${reportesNuevos.length} reportes procesados exitosamente</li>
                    <li>‚ûï ${reportesNuevosCount} reportes agregados como nuevos</li>
                    <li>üîÑ ${reportesActualizados} reportes actualizados</li>
                    <li>üìÅ ${listasProcesadas.size} listas procesadas</li>
                </ul>
            </div>
        `;
        container.style.display = 'block';

        if (reportesInvalidos > 0) {
            showToast(`Advertencia: ${reportesInvalidos} reportes fueron omitidos por datos inv√°lidos`, 'warning');
        } else {
            showToast('Carga masiva completada exitosamente!', 'success');
        }

        // Recargar datos
        await cargarReportesGuardados();
        await loadLists();

    } catch (error) {
        console.error('Error en procesamiento masivo:', error);
        showToast('Error durante el procesamiento masivo: ' + error.message, 'error');
        throw error;
    }
}



        /**
         * Procesa la lista y retorna el ID correspondiente
         */
        async function procesarLista(nombreLista) {
            try {
                if (!nombreLista || nombreLista.trim().toLowerCase() === 'false') {
                    return null;
                }

                const nombreListaLimpio = nombreLista.trim();
                const listas = await fetchAPI('/lists');
                let listaExistente = listas.find(l =>
                    l.name.toLowerCase() === nombreListaLimpio.toLowerCase()
                );

                if (!listaExistente) {
                    const nuevaLista = await fetchAPI('/lists', {
                        method: 'POST',
                        body: JSON.stringify({ name: nombreListaLimpio })
                    });
                    return nuevaLista.id;
                }

                return listaExistente.id;
            } catch (error) {
                console.error('Error procesando lista:', error);
                return null;
            }
        }

        /**
         * Genera un reporte desde una fila CSV
         */
        async function generarReporteDesdeCSV(headers, valores) {
            try {
                const datos = {};
                headers.forEach((header, index) => {
                    datos[header] = valores[index] ? valores[index].trim() : '';
                });

                // Validaci√≥n estricta de campos obligatorios
                const camposObligatorios = [
                    'nombreEstudiante',
                    'fecha',
                    'nombreDocente',
                    'asignatura',
                    'carrera',
                    'tituloEvaluacion'
                ];

                // Verificar que todos los campos obligatorios tengan valores v√°lidos
                for (const campo of camposObligatorios) {
                    if (!datos[campo] || datos[campo] === 'FALSE' || datos[campo] === 'TRUE') {
                        throw new Error(`Campo ${campo} inv√°lido o vac√≠o en la fila`);
                    }
                }

                // Validar fecha
                const fecha = new Date(datos.fecha);
                if (isNaN(fecha.getTime())) {
                    throw new Error('Formato de fecha inv√°lido');
                }

                // Procesar criterios
                let criterios = [];
                let puntajeTotal = 0;
                let puntajeMaximo = 0;
                let criterioIndex = 1;
                let criteriosValidos = false;

                while (datos[`criterio${criterioIndex}_nombre`]) {
                    const nombreCriterio = datos[`criterio${criterioIndex}_nombre`].trim();
                    const evaluacion = parseInt(datos[`criterio${criterioIndex}_evaluacion`]);

                    if (nombreCriterio && !isNaN(evaluacion) && evaluacion >= 0 && evaluacion <= 3) {
                        criterios.push({
                            nombre: nombreCriterio,
                            evaluacion: evaluacion,
                            nivelAlcanzado: obtenerNivelPorPuntaje(evaluacion),
                            excelente: "Nivel excelente (3 pts)",
                            bueno: "Nivel bueno (2 pts)",
                            regular: "Nivel regular (1 pt)",
                            insuficiente: "Nivel insuficiente (0 pts)"
                        });
                        puntajeTotal += evaluacion;
                        puntajeMaximo += 3;
                        criteriosValidos = true;
                    }
                    criterioIndex++;
                }

                if (!criteriosValidos) {
                    throw new Error('No se encontraron criterios v√°lidos');
                }

                // Calcular nota
                const notaMinima = 1.0;
                const notaMaxima = 7.0;
                const notaAprobacion = 4.0;
                const exigencia = 60;

                const porcentajeLogro = (puntajeTotal / puntajeMaximo) * 100;

                let notaFinal;
                if (porcentajeLogro >= exigencia) {
                    const factorExtra = (porcentajeLogro - exigencia) / (100 - exigencia);
                    notaFinal = notaAprobacion + (factorExtra * (notaMaxima - notaAprobacion));
                } else {
                    const factorBase = porcentajeLogro / exigencia;
                    notaFinal = notaMinima + (factorBase * (notaAprobacion - notaMinima));
                }

                // Validar puntos adicionales
                let puntosAdicionales = false;
                let puntosAgregar = 0;
                if (datos.puntosAdicionales && datos.puntosAdicionales.toLowerCase() === 'true') {
                    puntosAdicionales = true;
                    puntosAgregar = parseFloat(datos.puntosAgregar) || 0;
                    if (puntosAgregar > 0) {
                        notaFinal += puntosAgregar;
                    }
                }

                notaFinal = Math.max(notaMinima, Math.min(notaMaxima, notaFinal));
                notaFinal = Math.round(notaFinal * 10) / 10;

                // Crear reporte con datos validados
                const reporte = {
                    id: crypto.randomUUID(),
                    infoGeneral: {
                        nombreEstudiante: datos.nombreEstudiante.trim(),
                        fecha: fecha.toISOString().split('T')[0],
                        nombreDocente: datos.nombreDocente.trim(),
                        asignatura: datos.asignatura.trim(),
                        carrera: datos.carrera.trim(),
                        universidad: (datos.universidad || currentUser.university).trim(),
                        tituloEvaluacion: datos.tituloEvaluacion.trim(),
                        descripcionEvaluacion: (datos.descripcionEvaluacion || '').trim()
                    },
                    configuracion: {
                        notaMinima,
                        notaMaxima,
                        notaAprobacion,
                        exigencia,
                        incremento: 0.1
                    },
                    nivelesDesempeno: [...nivelesDesempeno],
                    criterios,
                    feedback: {
                        comentario: (datos.feedbackDocente || '').trim(),
                        puntosAdicionales,
                        puntosAgregar,
                        justificacionPuntos: (datos.justificacionPuntos || '').trim()
                    },
                    resultados: {
                        notaFinal,
                        puntajeTotal,
                        puntajeMaximo,
                        porcentajeLogro
                    },
                    fechaCreacion: new Date().toISOString(),
                    usuarioId: currentUser.id
                };

                // Procesar lista de manera m√°s robusta
                if (datos.lista) {
                    const listaId = await procesarLista(datos.lista);
                    if (listaId) {
                        reporte.listaId = listaId;
                        reporte.list_id = listaId; // Asegurar compatibilidad con ambos formatos
                    }
                }
                return reporte;
            } catch (error) {
                console.error('Error en generaci√≥n de reporte:', error);
                return null;
            }
        }


        /**
         * Obtiene el nivel por puntaje
         */
        function obtenerNivelPorPuntaje(puntaje) {
            const nivel = nivelesDesempeno.find(n => n.puntaje === puntaje);
            return nivel ? nivel.nombre : 'No definido';
        }

        /**
         * Procesa los reportes generados masivamente
         */
        async function procesarReportesMasivos(reportesNuevos) {
            if (!Array.isArray(reportesNuevos) || reportesNuevos.length === 0) {
                throw new Error('No hay reportes v√°lidos para procesar');
            }

            const sobrescribir = document.getElementById('sobrescribirReportes').checked;
            let reportesActualizados = 0;
            let reportesNuevosCount = 0;
            const listasProcesadas = new Set();

            let reportesInvalidos = 0;
            for (const reporteNuevo of reportesNuevos) {
                if (!reporteNuevo) {
                    reportesInvalidos++;
                    continue;
                }
                // ... resto del c√≥digo
            }
        }


        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================

        document.addEventListener('DOMContentLoaded', function () {
            initAuth();
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('fecha')) {
                document.getElementById('fecha').value = today;
            }
        });



/**
 * Elimina una lista y todos sus reportes asociados
 * @param {string} listaId - ID de la lista a eliminar
 * @param {string} listaNombre - Nombre de la lista (para mensajes)
 */
async function eliminarListaCompleta(listaId, listaNombre) {
    try {
        const confirmed = await showCustomDialog(
            'Confirmar eliminaci√≥n',
            `¬øEst√° seguro de eliminar la lista "${listaNombre}" y todos sus reportes asociados? Esta acci√≥n no se puede deshacer.`
        );

        if (!confirmed) return;

        // Obtener todos los reportes asociados a la lista
        const reportes = await fetchAPI('/reports');
        const reportesLista = reportes.filter(r => 
            r.listaId === listaId || r.list_id === listaId
        );

        console.log(`Eliminando lista ${listaNombre} (${listaId}) con ${reportesLista.length} reportes`);

        // Eliminar todos los reportes asociados
        await Promise.all(
            reportesLista.map(reporte => 
                fetchAPI(`/reports/${reporte.id}`, { method: 'DELETE' })
            )
        );

        // Eliminar la lista
        await fetchAPI(`/lists/${listaId}`, { method: 'DELETE' });

        showToast(`Lista "${listaNombre}" y ${reportesLista.length} reportes eliminados exitosamente.`, 'success');

        // Recargar datos
        await cargarReportesGuardados();
        await loadLists();

    } catch (error) {
        console.error('Error al eliminar lista:', error);
        showToast(`Error al eliminar la lista: ${error.message}`, 'error');
    }
}

/**
 *load list
 */

/**
 * Carga las listas disponibles
 */
async function loadLists() {
    try {
        const [reportes, listas] = await Promise.all([
            fetchAPI('/reports'),
            fetchAPI('/lists')
        ]);

        console.log('=== Debug loadLists ===');
        console.log('Total reportes:', reportes.length);
        console.log('Total listas en DB:', listas.length);

        // Crear mapa de listas activas y contar reportes por lista
        const listasActivas = new Map();
        const reportesPorLista = new Map();

        reportes.forEach(reporte => {
            const listaId = reporte.listaId || reporte.list_id;
            if (listaId) {
                const lista = listas.find(l => l.id === listaId);
                if (lista) {
                    listasActivas.set(lista.id, lista);
                    reportesPorLista.set(lista.id, (reportesPorLista.get(lista.id) || 0) + 1);
                }
            }
        });

        const listasActivasArray = Array.from(listasActivas.values());

        // Actualizar selectores
        const selects = ['listaExistente', 'filtroLista', 'listaAEliminar'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (!select) return;

            const currentValue = select.value;
            
            // Limpiar select
            select.innerHTML = selectId === 'filtroLista' ? 
                '<option value="">Todas las Listas</option>' : 
                '<option value="">-- Seleccione una lista --</option>';

            // Agregar opciones
            listasActivasArray.forEach(lista => {
                const option = document.createElement('option');
                option.value = lista.id;
                const reportesCount = reportesPorLista.get(lista.id) || 0;
                option.textContent = `${lista.name} (${reportesCount} reportes)`;
                if (currentValue === lista.id.toString()) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        });

        // Agregar √∫nico bot√≥n de eliminar listas
        const filterSection = document.querySelector('.filter-row');
        if (filterSection) {
            let eliminarBtn = filterSection.querySelector('#eliminarListasBtn');
            
            // Solo crear el bot√≥n si hay listas activas y no existe
            if (!eliminarBtn && listasActivasArray.length > 0) {
                eliminarBtn = document.createElement('button');
                eliminarBtn.id = 'eliminarListasBtn';
                eliminarBtn.className = 'btn btn-danger';
                eliminarBtn.innerHTML = 'üóëÔ∏è Eliminar Lista';
                eliminarBtn.onclick = () => {
                    const modal = document.getElementById('eliminarListaModal');
                    if (modal) {
                        let infoContainer = modal.querySelector('.listas-info');
                        
                        // Crear el contenedor de informaci√≥n si no existe
                        if (!infoContainer) {
                            infoContainer = document.createElement('div');
                            infoContainer.className = 'listas-info';
                            modal.querySelector('.modal-content > div').insertBefore(
                                infoContainer,
                                modal.querySelector('.form-group')
                            );
                        }
                        
                        // Mostrar informaci√≥n de las listas
                        const infoHTML = `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                <h4 style="margin-bottom: 0.5rem;">Resumen de Listas:</h4>
                                <ul style="list-style: none; padding: 0;">
                                    ${Array.from(listasActivas.values()).map(lista => `
                                        <li style="margin-bottom: 0.5rem;">
                                            <strong>${lista.name}</strong>: 
                                            <span class="text-gray-600">
                                                ${reportesPorLista.get(lista.id)} reportes
                                            </span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                        
                        infoContainer.innerHTML = infoHTML;
                    }
                    modal.classList.add('active');
                };
                
                // Agregar el bot√≥n despu√©s del bot√≥n "Aplicar Filtros"
                const aplicarFiltrosBtn = filterSection.querySelector('#aplicarFiltros');
                if (aplicarFiltrosBtn) {
                    aplicarFiltrosBtn.parentNode.insertBefore(eliminarBtn, aplicarFiltrosBtn.nextSibling);
                } else {
                    filterSection.appendChild(eliminarBtn);
                }
            } else if (eliminarBtn && listasActivasArray.length === 0) {
                eliminarBtn.remove();
            }
        }

        return listasActivasArray;
    } catch (error) {
        console.error('Error al cargar las listas:', error);
        showToast('Error al cargar las listas', 'error');
        return [];
    }
}



/**
 * MEJORA ADICIONAL: Validar listas antes de mostrar el modal
 */
async function abrirModalEliminarLista() {
    try {
        // Recargar listas antes de mostrar el modal para asegurar sincronizaci√≥n
        console.log("üîÑ Actualizando listas antes de mostrar modal...");
        await loadLists();
        
        const modal = document.getElementById('eliminarListaModal');
        const select = document.getElementById('listaAEliminar');
        
        // Verificar si hay listas disponibles despu√©s de la actualizaci√≥n
        if (select.options.length <= 1) {
            showToast('No hay listas disponibles para eliminar.', 'info');
            return;
        }
        
        // Mostrar informaci√≥n actualizada de las listas
        const infoContainer = modal.querySelector('.listas-info');
        if (infoContainer) {
            // Obtener informaci√≥n actualizada
            const listas = await fetchAPI('/lists');
            const reportes = await fetchAPI('/reports');
            
            const listasActivas = new Map();
            const reportesPorLista = new Map();
            
            reportes.forEach(reporte => {
                const listaId = reporte.listaId || reporte.list_id;
                if (listaId) {
                    const lista = listas.find(l => l.id === listaId);
                    if (lista) {
                        listasActivas.set(lista.id, lista);
                        reportesPorLista.set(lista.id, (reportesPorLista.get(lista.id) || 0) + 1);
                    }
                }
            });
            
            if (listasActivas.size === 0) {
                showToast('No hay listas con reportes asociados para eliminar.', 'info');
                return;
            }
            
            const infoHTML = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                    <h4 style="margin-bottom: 0.5rem;">Listas disponibles para eliminar:</h4>
                    <ul style="list-style: none; padding: 0;">
                        ${Array.from(listasActivas.values()).map(lista => `
                            <li style="margin-bottom: 0.5rem;">
                                <strong>${lista.name}</strong>: 
                                <span style="color: #718096;">
                                    ${reportesPorLista.get(lista.id)} reportes asociados
                                </span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            
            infoContainer.innerHTML = infoHTML;
        }
        
        modal.classList.add('active');
        console.log("‚úÖ Modal de eliminaci√≥n mostrado con datos actualizados");
        
    } catch (error) {
        console.error('Error al abrir modal de eliminaci√≥n:', error);
        showToast('Error al cargar la informaci√≥n de las listas.', 'error');
    }
}

// ==========================================
// CORRECCI√ìN PARA ELIMINAR LISTAS
// ==========================================


/**
 * SOLUCI√ìN: Manejar el caso donde la lista ya no existe
 * Reemplaza tu funci√≥n eliminarListaCompleta actual con esta versi√≥n
 */
async function eliminarListaCompleta() {
    console.log("=== INICIANDO PROCESO DE ELIMINACI√ìN ===");
    
    const select = document.getElementById('listaAEliminar');
    const listaId = select.value;
    
    if (!listaId) {
        console.log("No se seleccion√≥ ninguna lista");
        showToast('Por favor seleccione una lista para eliminar.', 'error');
        return;
    }

    const listaNombre = select.options[select.selectedIndex].text.split(' (')[0];
    console.log("Intentando eliminar lista:", { id: listaId, nombre: listaNombre });

    try {
        console.log("üìã Mostrando di√°logo de confirmaci√≥n...");
        
        const confirmed = await new Promise((resolve) => {
            const dialog = document.getElementById('custom-dialog');
            const titleEl = document.getElementById('dialog-title');
            const messageEl = document.getElementById('dialog-message');
            const confirmBtn = document.getElementById('dialog-confirm-btn');
            const cancelBtn = document.getElementById('dialog-cancel-btn');
            
            // Configurar el di√°logo
            titleEl.textContent = 'Confirmar eliminaci√≥n';
            messageEl.textContent = `¬øEst√° seguro de eliminar la lista "${listaNombre}"? Se eliminar√°n todos los reportes asociados.`;
            cancelBtn.style.display = 'inline-block';
            confirmBtn.textContent = 'Confirmar';
            
            const handleConfirm = () => {
                console.log("‚úÖ Usuario confirm√≥ la eliminaci√≥n");
                dialog.classList.remove('active');
                cleanup();
                resolve(true);
            };
            
            const handleCancel = () => {
                console.log("‚ùå Usuario cancel√≥ la eliminaci√≥n");
                dialog.classList.remove('active');
                cleanup();
                resolve(false);
            };
            
            const cleanup = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            
            dialog.classList.add('active');
        });

        if (!confirmed) {
            console.log("‚ùå Eliminaci√≥n cancelada por el usuario");
            return;
        }
        
        console.log("üîÑ Iniciando proceso de eliminaci√≥n...");
        
        // Deshabilitar bot√≥n para evitar clics m√∫ltiples
        const btnEliminar = document.getElementById('confirmarEliminarLista');
        const textoOriginal = btnEliminar.innerHTML;
        btnEliminar.innerHTML = '<div class="loading"></div> Eliminando...';
        btnEliminar.disabled = true;
        
        console.log("üìä Obteniendo reportes...");

        // Obtener reportes asociados a la lista
        const reportes = await fetchAPI('/reports');
        console.log(`üìã Total de reportes del usuario: ${reportes.length}`);
        
        const reportesLista = reportes.filter(r => {
            const coincide = (r.listaId && r.listaId.toString() === listaId.toString()) || 
                           (r.list_id && r.list_id.toString() === listaId.toString());
            if (coincide) {
                console.log(`üìÑ Reporte encontrado: ${r.id} - Lista ID: ${r.listaId || r.list_id}`);
            }
            return coincide;
        });

        console.log(`üéØ Reportes asociados a eliminar: ${reportesLista.length}`);

        // Eliminar reportes asociados primero
        if (reportesLista.length > 0) {
            console.log("üóëÔ∏è Eliminando reportes asociados...");
            for (const reporte of reportesLista) {
                try {
                    console.log(`üóëÔ∏è Eliminando reporte ${reporte.id}...`);
                    await fetchAPI(`/reports/${reporte.id}`, { method: 'DELETE' });
                    console.log(`‚úÖ Reporte ${reporte.id} eliminado exitosamente`);
                } catch (error) {
                    console.error(`‚ùå Error eliminando reporte ${reporte.id}:`, error);
                }
            }
        }

        // AQU√ç ES EL CAMBIO CLAVE: Manejar el caso de lista inexistente
        try {
            console.log(`üóëÔ∏è Eliminando lista con ID: ${listaId}...`);
            await fetchAPI(`/lists/${listaId}`, { method: 'DELETE' });
            console.log(`‚úÖ Lista ${listaId} eliminada exitosamente`);
        } catch (error) {
            if (error.message === 'Not Found') {
                console.log(`‚ö†Ô∏è La lista ${listaId} ya no existe en la base de datos`);
                console.log(`‚ÑπÔ∏è Esto puede ocurrir si la lista fue eliminada previamente`);
                // No lanzar error, continuar con el proceso normal
            } else {
                // Si es otro tipo de error, s√≠ lanzarlo
                throw error;
            }
        }

        // Mostrar mensaje de √©xito
        const reportesEliminados = reportesLista.length;
        if (reportesEliminados > 0) {
            showToast(`Lista "${listaNombre}" procesada: ${reportesEliminados} reportes eliminados.`, 'success');
        } else {
            showToast(`Lista "${listaNombre}" procesada exitosamente.`, 'success');
        }
        
        // Cerrar modal
        console.log("üîÑ Cerrando modales...");
        cerrarModales();

        // Recargar datos para sincronizar
        console.log("üîÑ Recargando datos para sincronizar...");
        await Promise.all([
            cargarReportesGuardados(),
            loadLists()
        ]);
        
        console.log("‚úÖ Proceso de eliminaci√≥n completado exitosamente");

    } catch (error) {
        console.error('‚ùå Error en el proceso de eliminaci√≥n:', error);
        showToast(`Error al procesar la eliminaci√≥n: ${error.message}`, 'error');
    } finally {
        // Restaurar el bot√≥n
        console.log("üîß Restaurando bot√≥n...");
        const btnEliminar = document.getElementById('confirmarEliminarLista');
        if (btnEliminar) {
            btnEliminar.innerHTML = 'Eliminar Lista';
            btnEliminar.disabled = false;
        }
    }
}
/**
 * Configuraci√≥n mejorada del event listener para eliminar lista
 * Agregar esto en la funci√≥n initMainApp()
 */
function configurarEliminarLista() {
    const btnConfirmar = document.getElementById('confirmarEliminarLista');
    if (btnConfirmar) {
        // Remover listeners existentes para evitar duplicados
        btnConfirmar.replaceWith(btnConfirmar.cloneNode(true));
        
        // Agregar el nuevo listener
        document.getElementById('confirmarEliminarLista').addEventListener('click', eliminarListaCompleta);
    }
}

/**
 * Mejora del fetchAPI para manejar mejor los errores 404
 */
async function fetchAPIWithBetterErrorHandling(endpoint, options = {}) {
    const token = localStorage.getItem('userToken');
    const headers = {
        'Content-Type': 'application/json',
        ...options.headers
    };
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch(`/api${endpoint}`, {
        ...options,
        headers
    });

    if (!response.ok) {
        if (response.status === 404) {
            throw new Error('Not Found');
        }
        
        try {
            const error = await response.json();
            throw new Error(error.message);
        } catch (parseError) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    }

    return response.json();
}
   </script>
</body>
</html>